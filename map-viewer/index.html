<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Speeding analysis at Uusimaa region</title>
  <meta name="description" content="Map Viewer Test">
  <meta name="author" content="">

  <link rel="stylesheet" href="leaflet.css" />
  <link rel="stylesheet" href="jquery-ui.css">
  <script src="moment-with-locales.js"></script>
  <script src="leaflet.js"></script>
  <script src="proj4.js"></script>
  <script src="proj4leaflet.js"></script>
  <script src="jquery-3.3.1.min.js"></script>
  <script src="Chart.js"></script>
  <script src="jquery.csv.js"></script>
  <script src="jquery-ui.js"></script>
</head>

<body>
  <div id="header" style="height: 80px; width: 100%; display: block;"><h1 id="page_title">Speeding analysis at Uusimaa region</h1><div id="slider" style="width: 96%; margin: auto;"></div></div>
  <div id="content" style="width: 100%; display: block;">
    <div id="map" style="height: 800px; width: 49%; display: inline-block; float: left; margin-right: 5px;"></div>
    <div id="details" style="height: 800px; width: 49%; display: inline-block; margin-left: 5px;"></div>
  </div>
  
  <script>
    var selectedDate = moment("2015 1", "YYYY DDD");
    
    var bounds, crsName, crsOpts, originNw, projDef, zoomLevels;
    zoomLevels = [8192, 4096, 2048, 1024, 512, 256, 128, 64, 32, 16, 8, 4, 2, 1, 0.5, 0.25];
    crsName = 'EPSG:3067';
    projDef = '+proj=utm +zone=35 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs';
    bounds = L.bounds(L.point(-548576, 6291456), L.point(1548576, 8388608));
    originNw = L.point(bounds.min.x, bounds.max.y);
    crsOpts = {
        resolutions: zoomLevels,
        bounds: bounds,
        transformation: new L.Transformation(1, -originNw.x, -1, originNw.y)
    };
    var tm35 = new L.Proj.CRS(crsName, projDef, crsOpts);

	var map = L.map('map', {'crs': tm35 } );
	L.tileLayer('map_tiles/{z}/{x}_{y}.png', {
		minZoom: 7,
		maxZoom: 10,
		tileSize: 1024,
		attribution: 'Taustakarttasarja 15.9.2018 &copy; <a href="https://www.maanmittauslaitos.fi">Maanmittauslaitos</a>, ' +
			'<a href="http://creativecommons.org/licenses/by/4.0/deed.fi">CC-BY 4.0</a>' ,
		id: 'taustakartta'
	}).addTo(map);
	
	L.control.scale().addTo(map);
    
    var trafficData = [];
    
    //$.get('../combined.csv', function (response) {
    //    trafficData = $.csv.toObjects(response);;
    //});
	
	//var yliopisto = L.marker([60.204722, 24.962778]).addTo(map);

    map.setView([60.204722, 24.962778], 7);
    
    
    function showTrafficInformation( station, date ) {
        var dayData = trafficData.filter(function (line) {
            return line['station_id'] == station &&
            line['year'] == date.year()  &&
            line['day'] == date.dayOfYear();
        });
            
        var totalCars = [];
        dayData.forEach( function(item){
            totalCars.push({ y: item['n_cars'], x: moment(item['year'] + " " + item['day'] + " " + item['hour'], "YYYY DDD hh") })
        });
            
        var speeders = [];
        dayData.forEach( function(item){
            speeders.push({ y: item['n_speeding_cars'], x: moment(item['year'] + " " + item['day'] + " " + item['hour'], "YYYY DDD hh") })
        });            
            
        var ctx = document.getElementById("stationChart").getContext('2d');
        var stationChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                        label: 'Number of cars',
                        data: totalCars
                    },
                    {
                        label: 'Speeding cars',
                        backgroundColor: 'rgba(0, 0, 0, 0.4)',
                        data: speeders
                    }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    xAxes: [{
                        type: 'time',
                        time: {
                            unit: 'hour',
                            displayFormats: {
                                hour: 'HH:mm'
                            }
                        }
                    }]
                }
            }
        });
        ctx.height = 200;
    }
    
    function onEachLAMPoint(feature, layer) {
        var name = "";
        var stationId = feature.properties.tmsNumber;
        if( ! feature.properties.names.en ) {
            name = feature.properties.name ;
        } else {
            name = feature.properties.names.en;
        }
        var content = "<h3>LAM station " + name + " (station number: " + stationId + ")</h3><p>Data browser, select date to see this stations traffic measurements (if available.) Date: <input type=\"text\" id=\"datepicker\"></p><div style=\"height: 600px; \"><canvas id=\"stationChart\"></canvas></div>";
        
        layer.on( 'click', function( e ) {
            $('#details').html(content);
            
            $( "#datepicker" ).datepicker( { minDate: new Date(2015, 1 - 1, 1),
                dateFormat: "yy-mm-dd",
                onSelect: function(dateText, inst) {
                    selectedDate = moment( dateText );
                    showTrafficInformation( stationId, selectedDate );
                }
            });
            
            $( "#datepicker" ).datepicker( "setDate", selectedDate.toDate());
            showTrafficInformation( stationId, selectedDate );
            
        });
    }
    
    function onEachPredictionPoint(feature, layer) {
        var content = "<h3>Prediction point at Road " + feature.properties.roadAddress.roadNumber +" (point id: "+ feature.id + ")</h3><p>Prediction result: " + feature.properties.predictionResult + " speeding drivers per hour (both directions combined)</p>";
        
        layer.on( 'click', function( e ) {
            $('#details').html(content);
        });
    }
    
    var prediction_points;
    function loadPredictionDatasetToMap() {
        var start_time = prediction_times[ selected_prediction_time ];
        var end_time = start_time.clone().add(1, 'hours');
        var new_title = "Speeding analysis at Uusimaa region - " + start_time.format("YYYY-MM-DD HH:mm") + " - " + end_time.format("HH:mm");
        document.title = new_title;
        
        if( prediction_points ) {
            map.removeLayer( prediction_points );
        }
        
        prediction_points = new L.geoJson("", {
            pointToLayer: function (feature, latlng) {
                var predictionPointMarkerOptions = {
                    radius: 2 + Math.log( feature.properties.predictionResult ),
                    fillColor: feature.properties.predictionResultColor,
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                };
                return L.circleMarker(latlng, predictionPointMarkerOptions);
            },
            onEachFeature: onEachPredictionPoint
        });
        prediction_points.addTo(map);
        
        $(prediction_point_datasets[ selected_prediction_time ].features).each(function(key, data) {
            prediction_points.addData(data);
        });
        
        $('#page_title').html( new_title );
    };
    
    

    var selected_prediction_time;
    var prediction_point_datasets = [];
    var prediction_times = [];
    $( function() {
        $.getJSON('data/prediction_points_updated.json', function (response) {
            var prediction_point_data = response;
            
            // hack to get dates in correct format
            for (i = 0; i < prediction_point_data.features.length; i++ ) {
                for (j = 0; j < prediction_point_data.features[i].properties.data.length; j++ )  {
                    var temp_date = prediction_point_data.features[i].properties.data[j].date.replace( 'EET', '');
                    temp_date = temp_date.replace( 'EEST', '');
                    temp_date = temp_date.slice(0, -2) + ':00';
                    prediction_point_data.features[i].properties.data[j].date = moment(temp_date, "YYYY-MM-DD HH:mm:ss ZZ");
                }
            }
            
            $(prediction_point_data.features[0].properties.data).each(function(key, data) {
                prediction_times.push( data.date );
            });
            
            prediction_times = prediction_times.sort(function(a, b){
                return moment(a).format('X')-moment(b).format('X')
            });
            
            var template_prediction_times = JSON.parse(JSON.stringify(prediction_point_data)); 
            for (i = 0; i < template_prediction_times.features.length; i++ ) {
                delete template_prediction_times.features[i].properties.data;
            }
            
            $(prediction_times).each( function(key, timestamp) {
                var temp_prediction_times = JSON.parse(JSON.stringify(template_prediction_times)); 
                
                for (i = 0; i < prediction_point_data.features.length; i++ ) {
                    for (j = 0; j < prediction_point_data.features[i].properties.data.length; j++ )  {
                        if (prediction_point_data.features[i].properties.data[j].date.isSame( timestamp )) {
                            temp_prediction_times.features[i].properties.predictionResultColor = prediction_point_data.features[i].properties.data[j].predictionResultColor;
                            temp_prediction_times.features[i].properties.predictionResult = prediction_point_data.features[i].properties.data[j].predictionResult;
                            break;
                        }
                    }
                }
            
                prediction_point_datasets.push( temp_prediction_times );
            });
            
            selected_prediction_time = 0;
            
            $( "#slider" ).slider({
                min: 0, 
                max: prediction_times.length - 1,
                change: function(event, ui ) {
                    selected_prediction_time = ui.value;
                    loadPredictionDatasetToMap();
                }
            });
            
            loadPredictionDatasetToMap();
        });
    } );

    var lam_points = new L.geoJson("", {onEachFeature: onEachLAMPoint});
	lam_points.addTo(map);

	$.ajax({
        dataType: "json",
        url: "data/tms-stations-uusimaa.json",
        success: function(data) {
            $(data.features).each(function(key, data) {
                lam_points.addData(data);
            });
        }
	});
    
  </script>
</body>
</html>

