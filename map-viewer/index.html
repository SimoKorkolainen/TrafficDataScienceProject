<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Speeding analysis at Uusimaa region - 2018-08-01 09:00 - 10:00</title>
  <meta name="description" content="Map Viewer Test">
  <meta name="author" content="">

  <link rel="stylesheet" href="leaflet.css" />
  <link rel="stylesheet" href="jquery-ui.css">
  <script src="moment-with-locales.js"></script>
  <script src="leaflet.js"></script>
  <script src="proj4.js"></script>
  <script src="proj4leaflet.js"></script>
  <script src="jquery-3.3.1.min.js"></script>
  <script src="Chart.js"></script>
  <script src="jquery.csv.js"></script>
  <script src="jquery-ui.js"></script>
</head>

<body>
  <div id="header" style="height: 40px; width: 100%; display: block;"><h1>Speeding analysis at Uusimaa region - 2018-08-01 09:00 - 10:00</h1></div>
  <div id="content" style="width: 100%; display: block;">
    <div id="map" style="height: 800px; width: 49%; display: inline-block; float: left;"></div>
    <div id="details" style="height: 800px; width: 49%; display: inline-block;"></div>
  </div>
  
  <script>	  
    var bounds, crsName, crsOpts, originNw, projDef, zoomLevels;
    zoomLevels = [8192, 4096, 2048, 1024, 512, 256, 128, 64, 32, 16, 8, 4, 2, 1, 0.5, 0.25];
    crsName = 'EPSG:3067';
    projDef = '+proj=utm +zone=35 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs';
    bounds = L.bounds(L.point(-548576, 6291456), L.point(1548576, 8388608));
    originNw = L.point(bounds.min.x, bounds.max.y);
    crsOpts = {
        resolutions: zoomLevels,
        bounds: bounds,
        transformation: new L.Transformation(1, -originNw.x, -1, originNw.y)
    };
    var tm35 = new L.Proj.CRS(crsName, projDef, crsOpts);

	var map = L.map('map', {'crs': tm35 } );
	L.tileLayer('map_tiles/{z}/{x}_{y}.png', {
		minZoom: 7,
		maxZoom: 10,
		tileSize: 1024,
		attribution: 'Taustakarttasarja 15.9.2018 &copy; <a href="https://www.maanmittauslaitos.fi">Maanmittauslaitos</a>, ' +
			'<a href="http://creativecommons.org/licenses/by/4.0/deed.fi">CC-BY 4.0</a>' ,
		id: 'taustakartta'
	}).addTo(map);
	
	L.control.scale().addTo(map);
    
    var trafficData;
    
    $.get('../combined.csv', function (response) {
        trafficData = $.csv.toObjects(response);;
    });
	
	//var yliopisto = L.marker([60.204722, 24.962778]).addTo(map);

    map.setView([60.204722, 24.962778], 7);
    
    function onEachLAMPoint(feature, layer) {
		//var popupContent = "<p>LAM station: <b>" + feature.properties.names.en + "</b></p>";
		//if (feature.properties && feature.properties.popupContent) {
		//	popupContent += feature.properties.popupContent;
		//}
		//layer.bindPopup(popupContent);
        var name = "";
        var stationId = feature.properties.tmsNumber;
        if( ! feature.properties.names.en ) {
            name = feature.properties.name ;
        } else {
            name = feature.properties.names.en;
        }
        var content = "<h3>LAM station " + name + " (station number: " + stationId + ")</h3><p>Date: <input type=\"text\" id=\"datepicker\"></p><canvas id=\"stationChart\" width=\"300\" height=\"300\"></canvas>";
        
        layer.on( 'click', function( e ) {
            $('#details').html(content);
            
            $( function() {
                $( "#datepicker" ).datepicker();
            } );
            
            var dayData = trafficData.filter(function (line) {
                return line['station_id'] == stationId &&
                    line['year'] == '2015' &&
                    line['day'] == '9';
            });
            
            var totalCars = [];
            dayData.forEach( function(item){
                totalCars.push({ y: item['n_cars'], x: moment(item['hour'], "hh") })
            });
            
            var speeders = [];
            dayData.forEach( function(item){
                speeders.push({ y: item['n_speeding_cars'], x: moment(item['hour'], "hh") })
            });            
            
            console.log(totalCars);
            
            var ctx = document.getElementById("stationChart").getContext('2d');
            var stationChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                            label: 'Number of cars',
                            data: totalCars
                        },
                        {
                            label: 'Speeding cars',
                            backgroundColor: 'rgba(0, 0, 0, 0.4)',
                            data: speeders
                        }]
                },
                options: {
                    scales: {
                        xAxes: [{
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'HH:mm'
                                }
                            }
                        }]
                    }
                }
            });
        });
    }
    
    function onEachPredictionPoint(feature, layer) {
        var content = "<h3>Prediction point at Road " + feature.properties.roadAddress.roadNumber +" (point id: "+ feature.id + ")</h3><p>Prediction result: " + Math.round(Number(feature.properties.predictionResult)) + " speeding drivers per hour (both directions combined)</p>";
        
        layer.on( 'click', function( e ) {
            $('#details').html(content);
        });
    }
    
    
    
    var prediction_points = new L.geoJson("", {
        pointToLayer: function (feature, latlng) {
            var predictionPointMarkerOptions = {
                radius: 2+ feature.properties.predictionResultLog1p,
                fillColor: feature.properties.predictionResultColor,
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            };
            return L.circleMarker(latlng, predictionPointMarkerOptions);
        },
        onEachFeature: onEachPredictionPoint
    });
	prediction_points.addTo(map);

	$.ajax({
        dataType: "json",
        url: "data/prediction_points_updated.json",
        success: function(data) {
            $(data.features).each(function(key, data) {
                prediction_points.addData(data);
            });
        }
	});
    
    var lam_points = new L.geoJson("", {onEachFeature: onEachLAMPoint});
	lam_points.addTo(map);

	$.ajax({
        dataType: "json",
        url: "data/tms-stations-uusimaa.json",
        success: function(data) {
            $(data.features).each(function(key, data) {
                lam_points.addData(data);
            });
        }
	});
    
  </script>
</body>
</html>

