<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Speeding analysis at Uusimaa region</title>
  <meta name="description" content="Map Viewer Test">
  <meta name="author" content="">

  <link rel="stylesheet" href="leaflet.css" />
  <link rel="stylesheet" href="jquery-ui.css" />
  <link rel="stylesheet" href="style.css" />
  <script type="text/javascript" src="moment-with-locales.js"></script>
  <script type="text/javascript" src="leaflet.js"></script>
  <script type="text/javascript" src="proj4.js"></script>
  <script type="text/javascript" src="proj4leaflet.js"></script>
  <script type="text/javascript" src="jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="Chart.js"></script>
  <script type="text/javascript" src="jquery.csv.js"></script>
  <script type="text/javascript" src="jquery-ui.js"></script>
  <script type="text/javascript" src="pako.js"></script>
</head>

<body>
  <div id="header"><h1 id="page_title">Speeding analysis at Uusimaa region</h1><div id="slider"></div></div>
  <div id="map"></div>
  <div id="loader"></div>
  
  <script>
    var selectedDate = moment("2015 1", "YYYY DDD");
    
    var bounds, crsName, crsOpts, originNw, projDef, zoomLevels;
    zoomLevels = [8192, 4096, 2048, 1024, 512, 256, 128, 64, 32, 16, 8, 4, 2, 1, 0.5, 0.25];
    crsName = 'EPSG:3067';
    projDef = '+proj=utm +zone=35 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs';
    bounds = L.bounds(L.point(-548576, 6291456), L.point(1548576, 8388608));
    originNw = L.point(bounds.min.x, bounds.max.y);
    crsOpts = {
        resolutions: zoomLevels,
        bounds: bounds,
        transformation: new L.Transformation(1, -originNw.x, -1, originNw.y)
    };
    var tm35 = new L.Proj.CRS(crsName, projDef, crsOpts);

	var map = L.map('map', {'crs': tm35 } );
	L.tileLayer('map_tiles/{z}/{x}_{y}.png', {
		minZoom: 7,
		maxZoom: 10,
		tileSize: 1024,
		attribution: 'Taustakarttasarja 15.9.2018 &copy; <a href="https://www.maanmittauslaitos.fi">Maanmittauslaitos</a>, ' +
			'<a href="http://creativecommons.org/licenses/by/4.0/deed.fi">CC-BY 4.0</a>' ,
		id: 'taustakartta'
	}).addTo(map);
	
	L.control.scale().addTo(map);
    
    var trafficData = [];
    
    //$.get('../combined.csv', function (response) {
    //    trafficData = $.csv.toObjects(response);;
    //});
	
	//var yliopisto = L.marker([60.204722, 24.962778]).addTo(map);

    map.setView([60.204722, 24.962778], 7);
    
    
    function showTrafficInformation( station, date ) {
        var dayData = trafficData.filter(function (line) {
            return line['station_id'] == station &&
            line['year'] == date.year()  &&
            line['day'] == date.dayOfYear();
        });
            
        var totalCars = [];
        dayData.forEach( function(item){
            totalCars.push({ y: item['n_cars'], x: moment(item['year'] + " " + item['day'] + " " + item['hour'], "YYYY DDD hh") })
        });
            
        var speeders = [];
        dayData.forEach( function(item){
            speeders.push({ y: item['n_speeding_cars'], x: moment(item['year'] + " " + item['day'] + " " + item['hour'], "YYYY DDD hh") })
        });            
            
        var ctx = document.getElementById("stationChart").getContext('2d');
        var stationChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                        label: 'Number of cars',
                        data: totalCars
                    },
                    {
                        label: 'Speeding cars',
                        backgroundColor: 'rgba(0, 0, 0, 0.4)',
                        data: speeders
                    }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    xAxes: [{
                        type: 'time',
                        time: {
                            unit: 'hour',
                            displayFormats: {
                                hour: 'HH:mm'
                            }
                        }
                    }]
                }
            }
        });
        ctx.height = 200;
    }
    
    function onEachLAMPoint(feature, layer) {
        var name = "";
        var stationId = feature.properties.tmsNumber;
        if( ! feature.properties.names.en ) {
            name = feature.properties.name ;
        } else {
            name = feature.properties.names.en;
        }
        var content = "<h3>LAM station " + name + " (station number: " + stationId + ")</h3><p>Data browser, select date to see this stations traffic measurements (if available.) Date: <input type=\"text\" id=\"datepicker\"></p><div style=\"height: 600px; \"><canvas id=\"stationChart\"></canvas></div>";
        
		layer.bindPopup(content);
        
        layer.on( 'click', function( e ) {            
            $( "#datepicker" ).datepicker( { minDate: new Date(2015, 1 - 1, 1),
                dateFormat: "yy-mm-dd",
                onSelect: function(dateText, inst) {
                    selectedDate = moment( dateText );
                    showTrafficInformation( stationId, selectedDate );
                }
            });
            
            $( "#datepicker" ).datepicker( "setDate", selectedDate.toDate());
            showTrafficInformation( stationId, selectedDate );
            
        });
    }
    
    function onEachPredictionPoint(feature, layer) {
        var content = "<h3>Prediction point at Road " + feature.properties.roadAddress.roadNumber +
        "</h3><ul><li>Latitude: " + feature.geometry.coordinates[1] + "</li><li>Longitude: " + 
        feature.geometry.coordinates[0] + "</li><li>Point ID: " + feature.id + 
        "</li><li>Prediction result: <b>" + feature.properties.predictionResult + 
        "</b> speeding drivers per hour (both directions combined)</li>" +
        "<li>Speed limit: " + feature.properties.speedLimit;
        
        if ( feature.properties.speedLimit != feature.properties.speedLimitWinter ) {
            content += " (winter limit: " + feature.properties.speedLimitWinter +")";
        }
        content += "</li></ul>";
        
        layer.bindPopup(content, {autoClose: false, closeOnClick: false});
    }
    
    var prediction_points;
    function loadPredictionDatasetToMap() {
        $('#loader').show();
        
        var start_time = prediction_times[ selected_prediction_time ];
        var end_time = start_time.clone().add(1, 'hours');
        var new_title = "Speeding analysis at Uusimaa region - " + start_time.format("YYYY-MM-DD HH:mm") + " - " + end_time.format("HH:mm");
        document.title = new_title;
        
        if( prediction_points ) {
            map.removeLayer( prediction_points );
        }
        
        prediction_points = new L.geoJson("", {
            pointToLayer: function (feature, latlng) {
                var predictionPointMarkerOptions = {
                    radius: 2 + Math.log2( feature.properties.predictionResult ),
                    fillColor: feature.properties.predictionResultColor,
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                };
                return L.circleMarker(latlng, predictionPointMarkerOptions);
            },
            onEachFeature: onEachPredictionPoint
        });
        prediction_points.addTo(map);
        
        $(prediction_point_datasets[ selected_prediction_time ].features).each(function(key, data) {
            prediction_points.addData(data);
        });
        
        $('#page_title').html( new_title );
        $('#loader').hide(250);
    };
    
    

    var selected_prediction_time;
    var prediction_point_datasets = [];
    var prediction_times = [];
    var prediction_point_data;
    var prediction_point_data2;
    
    $( function() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'data/prediction_points_updated2.json.gz', true);
        xhr.responseType = 'arraybuffer';
 
        xhr.onload = function(e) {
            if (this.status == 200) {
                prediction_point_data2 = this.response;
                prediction_point_data = JSON.parse( pako.ungzip( this.response ,{ to: 'string' }) );
            
                prediction_times = prediction_point_data.prediction_times;
                for (i = 0; i < prediction_times.length; i++ ) {
                    prediction_times[i] = moment(prediction_times[i], "YYYY-MM-DD HH:mm:ss ZZ");
                }
            
                prediction_point_datasets = prediction_point_data.datasets;
            
                selected_prediction_time = 0;
            
                $( "#slider" ).slider({
                    min: 0, 
                    max: prediction_times.length - 1,
                    change: function(event, ui ) {
                        selected_prediction_time = ui.value;
                        loadPredictionDatasetToMap();
                    }
                });
            
                loadPredictionDatasetToMap();
            }
        };
 
        xhr.send();
    } );

    var lam_points = new L.geoJson("", {onEachFeature: onEachLAMPoint});
	lam_points.addTo(map);

	$.ajax({
        dataType: "json",
        url: "data/tms-stations-uusimaa.json",
        success: function(data) {
            $(data.features).each(function(key, data) {
                lam_points.addData(data);
            });
        }
	});
    
  </script>
</body>
</html>

